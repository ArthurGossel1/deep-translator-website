{% extends 'base.html' %}

{% block content %}
    <body>
    <div class="mx-auto">
        <div class="flex min-h-screen justify-center bg-slate-200 pt-5 pb-2">
            <div class="mx-4 w-full rounded-lg bg-white p-6 sm:w-2/3 md:w-1/3 lg:w-1/2">
                <h2 class="mb-4 border-b-2 border-b-slate-500 text-2xl font-medium">Deep Translator</h2>
                <div class="relative mb-4">
                    <label for="translator-select" class="mb-2 block font-medium text-gray-700">Translator</label>
                    <select id="translator-select" name="translator-select" onchange="submitData()"
                            class="focus:shadow-outline-blue focus:border-black-300 w-full cursor-pointer appearance-none rounded-lg border border-gray-400 bg-white px-4 py-2 pr-8 leading-tight hover:border-gray-500 focus:outline-none">
                        <option disabled>Select a translator</option>
                        <option selected>Google</option>
                        <option>DeepL</option>
                        <option>MicrosoftTranslate</option>
                    </select>
                </div>

                <div class="mb-4">
                    <div class="relative mb-4">
                        <label for="input-language" class="mb-2 block font-medium text-gray-700">Text input</label>
                        <select id="input-language" name="input-language" onchange="submitData()"
                                class="focus:shadow-outline-blue w-full cursor-pointer appearance-none rounded-lg border border-gray-400 bg-white px-4 py-2 pr-8 leading-tight hover:border-gray-500 focus:border-blue-300 focus:outline-none">
                            <option disabled selected>Select input language</option>
                        </select>
                    </div>
                    <form>
                        {% csrf_token %}
                        <textarea id="src"
                                  class="w-full resize-none rounded-lg bg-sky-100 p-2 focus:bg-sky-200 focus:outline-none"
                                  rows="4"></textarea>
                    </form>

                </div>
                <div class="mb-4">
                    <div class="relative mb-4">
                        <label for="output-language" class="mb-2 block font-medium text-gray-700">Text output</label>
                        <select id="output-language" name="output-language" onchange="submitData()"
                                class="focus:shadow-outline-blue w-full cursor-pointer appearance-none rounded-lg border border-gray-400 bg-white px-4 py-2 pr-8 leading-tight hover:border-gray-500 focus:border-orange-300 focus:outline-none">
                            <option disabled selected>Select output language</option>
                        </select>
                    </div>
                    <textarea id="res" class="w-full resize-none rounded-lg bg-orange-100 p-2" rows="4"
                              disabled></textarea>
                </div>
                <div class="grid grid-cols-2 grid-rows-2 gap-4">
                    <button class="relative flex items-center justify-center gap-2 rounded-lg bg-red-500 p-2 text-white hover:bg-red-600">
                        <svg class="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6z"></path>
                        </svg>
                        Clear
                    </button>
                    <button onclick="swapLanguages()"
                            class="relative flex items-center justify-center gap-2 rounded-lg bg-gray-300 p-2 text-black hover:bg-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" class="h-6 w-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"></path>
                        </svg>
                        Swap
                    </button>
                    <button class="relative col-span-full flex items-center justify-center gap-2 rounded-lg bg-blue-500 p-2 text-white hover:bg-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" class="h-6 w-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path>
                        </svg>
                        Compare
                    </button>
                </div>
                <p class="mt-3">NB : <i>DeepTranslator</i> translate your text when you change it. No need to search
                    about a "Translate" button, just wait a bit ðŸ˜‡</p>
            </div>
        </div>
    </div>
    </body>
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
            integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const delay = 1000;

        let timer;

        // Get input textarea
        const src = $("#src");

        // Get output textarea
        const res = $("#res");

        // Get language selects
        const inputLanguageSelect = $("#input-language");
        const outputLanguageSelect = $("#output-language");

        // Get translator select
        const translatorSelect = $("#translator-select");

        // Get navigator language
        const navigatorLanguage = navigator.language.substring(0, 2);

        // Get translator languages options
        fetch("/static/utilities/languages-list.json").then(response => response.json()).then(data => {
            Object.entries(data).forEach(([code, name], _, arr) => {
                // Create options
                const inputLanguageOption = $("<option>");
                inputLanguageOption.val(code);
                inputLanguageOption.text(name);
                inputLanguageSelect.append(inputLanguageOption);

                const outputLanguageOption = $("<option>");
                outputLanguageOption.val(code);
                outputLanguageOption.text(name);
                outputLanguageSelect.append(outputLanguageOption);

                // Check if user language is supported, and select it for input language by default
                if (navigatorLanguage === code) {
                    inputLanguageOption.prop("selected", true);

                    // If user language is not english, set output as english by default
                    if (navigatorLanguage !== "en" && arr.find(([code]) => code === "en")) {
                        outputLanguageSelect.val("en");
                    }
                }
            });
        });

        src.on('input', code => {
            clearTimeout(timer);
            timer = setTimeout(submitData, delay, code);
        })

        function submitData() {
            const payload = {
                'text': src.val(),
                'source': inputLanguageSelect.val(),
                'target': outputLanguageSelect.val(),
                'translator': translatorSelect.val()
            }

            $.ajax({
                url: "/api/translate",
                headers: {'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()},
                method: 'POST',
                data: payload,
                success: function (result) {
                    res.val(result.text.replace('\n', '<br>'));
                }
            })
        }

        function swapLanguages() {
            // Get the selected value for the input language
            const inputLanguageValue = inputLanguageSelect.val();
            // Get the selected index for the input language
            const inputLanguageIndex = inputLanguageSelect.prop("selectedIndex");

            // Get the selected value for the output language
            const outputLanguageValue = outputLanguageSelect.val();
            // Get the selected index for the output language
            const outputLanguageIndex = outputLanguageSelect.prop("selectedIndex");

            // Get the text for the output textarea
            const resText = res.val();

            // Update the selection for the input language
            inputLanguageSelect.val(outputLanguageValue);
            inputLanguageSelect.prop("selectedIndex", outputLanguageIndex);

            // Update the selection for the output language
            outputLanguageSelect.val(inputLanguageValue);
            outputLanguageSelect.prop("selectedIndex", inputLanguageIndex);

            // Update the text for the input textarea
            src.val(resText);

            // Submit the data
            submitData();
        }
    </script>
{% endblock %}